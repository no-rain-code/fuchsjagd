<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<script type="text/javascript" charset="utf-8" src="phonegap-1.2.0.js"></script>
<script type="text/javascript" charset="utf-8" src="jquery-1.7.1.js"></script>
<script type="text/javascript"
	src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="fuchsjagd.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body style="font: 75% Lucida Grande, Trebuchet MS; margin: 0">
	<div id="space" style="line-height: 4;">&nbsp;</div>
	<div id="lat" class="messureText">&nbsp;</div>
	<div id="lng" class="messureText">&nbsp;</div>
	<div id="head" class="messureText">&nbsp;</div>
	<div id="space" style="line-height: 4;">&nbsp;</div>
	<div id="msg" class="message">Loading</div>
	<div id="err" class="error"></div>
	<div id="targets" class="targets"></div>
	<div class="reload">
        <img src="img/arrow_refresh.png" onclick="reload();">
    </div>
	<script>
		var options = {
			frequency : 150
		};
		// Schaffhausen 
		var searchPosition0 = {
			coords : {
				latitude : 47.707769,
				longitude : 8.641434
			}
		};
		// Basel 
		var searchPosition1 = {
			coords : {
				latitude : 47.557422,
				longitude : 7.592572
			}
		};
		// Lugano
		var searchPosition2 = {
			coords : {
				latitude : 46.006508,
				longitude : 8.952312
			}
		};
		// Genf
		var searchPosition3 = {
			coords : {
				latitude : 46.198391,
				longitude : 6.142291
			}
		};
		// Chur
		var searchPosition4 = {
			coords : {
				latitude : 46.857264,
				longitude : 9.526734
			}
		};

		// load
		var targets;
		//var targets = new Array(new target(searchPosition0, "Schaffhausen"),
		//		new target(searchPosition1, "Basel"), new target(
		//				searchPosition2, "Lugano"), new target(searchPosition3,
		//				"Genf"), new target(searchPosition4, "Chur"));

		var bearingToPosition = 0;
		// var myHeading = 0;
		var loading = 0;
		var headingReady = false;
		var positionReady = false;
		var targetsHTML = '';
		var targetsHidden = true;
		var t = setTimeout("onLoading()", 300);
		document.addEventListener("deviceready", onDeviceReady, false);
		
		function onLoading() {
			if (loading != -1) {
				if (loading >= 3) {
					loading = 0;
				} else {
					loading = loading + 1;
				}
				var points = '';
				for (var i = 0; loading > i; i++) {
					points = points + '.';
				}
				var elementMsg = document.getElementById('msg');
				elementMsg.innerHTML = 'Loading' + points;
				var t = setTimeout("onLoading()", 300);
			}
		}

		function onDeviceReady() {
			$.getJSON('http://fuchsjagd.ep.io/api/silent-mountain82/?callback=?', onDataLoaded);
		}

		function onDataLoaded(data) {
			targets = new Array(data[0].senders.length);
			$.each(data[0].senders, function(i,sender){
      			var searchPosition = {
					coords : {
						latitude : sender.latitude,
						longitude : sender.longitude
					}
				};
				targets[i] = new target(searchPosition,"Target-" + (i+1));
    		});
			
			if (navigator.geolocation) {
				//var elementLat = document.getElementById('lat');
				//var elementLng = document.getElementById('lng');
				//elementLat.innerHTML = 'Loading Latitude..';
				//elementLng.innerHTML = 'Loading Longitude..';
				navigator.geolocation.getCurrentPosition(showPosition, onError);
				// also monitor position as it changes
				navigator.geolocation.watchPosition(showPosition);
			} else {
				onError();
			}

			if (navigator.compass) {
				//var elementHead = document.getElementById('head');
				//elementHead.innerHTML = 'Loading Heading';
				navigator.compass.getCurrentHeading(showHeading, onErrorHeading, options);
				// also monitor heading as it changes
				navigator.compass.watchHeading(showHeading, onErrorHeading, options);
			} else {
				onErrorHeading();
			}
			
			for ( var i = 0; i < targets.length; i++) {
				targetsHTML = targetsHTML + makeTarget(targets[i].name);
			}
		}
		
		function resetAfterLoading() {
			if (loading>-1) {
				loading = -1;
				clearTimeout(t);
				clearView();
				document.getElementById('space').style.lineHeight = '2';
			}
		}

		function showPosition(position) {
			positionReady = true;
			if (headingReady == true) {
				resetAfterLoading();
				var lat = position.coords.latitude;
				var lng = position.coords.longitude;
				var elementLat = document.getElementById('lat');
				var elementLng = document.getElementById('lng');
				elementLat.innerHTML = "Latitude: " + lat;
				elementLng.innerHTML = "Longitude: " + lng;
				for ( var i = 0; i < targets.length; i++) {
					targets[i].update(position);
				}
			}
		}

		function showHeading(heading) {
			headingReady = true;
			if (positionReady == true) {
				resetAfterLoading();
				var head = heading.magneticHeading;
				var elementHead = document.getElementById('head');
				elementHead.innerHTML = "Heading: " + head;
	
				if (targetsHidden) {
					document.getElementById('targets').innerHTML = targetsHTML;
					targetsHidden = false;
				}
	
				for ( var i = 0; i < targets.length; i++) {
					var strength = targets[i].getStrength(head);
					document.getElementById(targets[i].name).style.width = strength + "%";
				}
				
				elementHead.innerHTML = makeCompass();
				adjustNeedle(head);
			}
		}
		
		function clearView() {
			document.getElementById('lat').innerHTML = '&nbsp;';
			document.getElementById('lng').innerHTML = '&nbsp;';
			document.getElementById('head').innerHTML = '&nbsp;';
			document.getElementById('msg').innerHTML = '';
			document.getElementById('err').innerHTML = '';
			document.getElementById('targets').innerHTML = '';
		}
		
		function adjustNeedle(heading) {
	        $("#needle").css("-webkit-transform","rotate(-" + heading + "deg)");
	        $("#needle").css("transform","rotate(-" + heading + "deg)");
		}
		
		function reload() {
			clearView();
			document.getElementById('msg').innerHTML = 'Loading';
			document.getElementById('space').style.lineHeight = '4';
			targets = new Array();
			loading = 0;
			headingReady = false;
			positionReady = false;
			targetsHTML = '';
			targetsHidden = true;
			t = setTimeout("onLoading()", 300);
			onDeviceReady();
		}
	</script>
</body>
</html>
